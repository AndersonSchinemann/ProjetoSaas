var app = angular.module('ListarApp', []);

app.service('usuarioService', function($http) {
	
	
    this.getAllUsuarios = function() {
        return $http.get('/api/usuarios')
            .then(function(response) {
                return response.data;
            })
            .catch(function(error) {
                console.log('Erro ao obter usuários:', error);
                alert("Erro ao obter usuários:");
                return [];
            });
    };

   this.deleteUsuario = function(usuario) {
    return $http.delete('/api/usuarios/' + usuario.id)
            .then(function() {
                alert("Usuário excluído com sucesso!");
                // Atualiza a lista de usuários após a exclusão
                return $scope.loadUsuarios();
                //return usuarioService.getAllUsuarios();
            })
            .catch(function(error) {
				console.log('Erro ao Deletar usuários:', error);
                //alert("Erro ao excluir usuário. Detalhes do erro: " + JSON.stringify(error));
                // Retorna uma promise rejeitada para que a cadeia de promessas não seja quebrada
                return Promise.reject(error);
            });
    };
    this.pesquisaUsuarios = function(searchText) {
        return $http.get('/api/usuarios/pesquisa', { params: { searchText: searchText } })
            .then(function(response) {
				//$scope.usuarios = response.data;
                return response.data;
            })
            .catch(function(error) {
                console.log('Erro ao pesquisar usuários:', error);
                return [];
            });
    };
   
    
});

app.filter('slice', function() {
    return function(arr, start, end) {
        return arr.slice(start, end);
    };
});

app.controller('UsuarioController',function ($scope, usuarioService) {
    $scope.usuarios = [];
    $scope.currentPage = 1;
    $scope.pageSize = 5;
    $scope.totalPages = 0;
    //$scope.searchText ="";

    $scope.loadUsuarios = function() {
       
        usuarioService.getAllUsuarios()
            .then(function(usuarios) {
                $scope.usuarios = usuarios;
                $scope.totalPages = Math.ceil($scope.usuarios.length / $scope.pageSize);
                $scope.setPage(1); // Defina a página para 1 ao carregar os usuários
            })
            .catch(function(error) {
                console.log('Erro ao carregar usuários:', error);
            });
    };

    $scope.loadUsuarios();
    
    $scope.abrirEdicao = function (usuario) {
		
      // Recuperar dados do usuário editável do usuarioService
      usuarioService.abrirEdicao(usuario)
        .then(function (usuarioEditavel) {
          // Definir os dados do usuário editável para a variável de escopo
          $scope.usuarioEditavel = usuarioEditavel;
        })
        .catch(function (error) {
          // Lidar com o erro na recuperação dos dados do usuário editável
          console.error('Erro ao recuperar o usuário editável:', error);
        });

      // Chamar o modal
      $('#edicaoUsuarioModal').modal('show');
    };
    $scope.setPage = function (page) {
        $scope.currentPage = page;
    };

    $scope.prevPage = function () {
        if ($scope.currentPage > 1) {
            $scope.currentPage--;
        }
    };

    $scope.nextPage = function () {
        if ($scope.currentPage < $scope.totalPages) {
            $scope.currentPage++;
        }
    };

    $scope.$watch('usuarios', function () {
        $scope.totalPages = Math.ceil($scope.usuarios.length / $scope.pageSize);
        if ($scope.currentPage > $scope.totalPages) {
            $scope.currentPage = $scope.totalPages;
        }
    });

    $scope.pesquisaUsuario = function () {
		alert("Pesquisa feita");
		usuarioService.pesquisaUsuarios($scope.searchText)
        .then(function(usuarios) {
            $scope.usuarios = usuarios; // Atualiza a lista de usuários
        });
    };
    $scope.deleteUsuario = function(usuario) {
        usuarioService.deleteUsuario(usuario);
    };
    $scope.atualizar = function() {
		alert("Atualizado");
       $scope.loadUsuarios();
	};
});



